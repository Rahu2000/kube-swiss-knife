name: Public Helm Charts Management

on:
  workflow_dispatch:
  push:
    paths:
      - "/ghe-helm-charts/asserts/helm-charts.txt"

env:
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

jobs:
  update-charts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: "v3.13.0"

      - name: Clean and prepare directories
        run: |
          # charts ë° docs ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p charts docs

          # ê¸°ì¡´ index.yaml ì‚­ì œ (ì¬ìƒì„±í•  ì˜ˆì •)
          rm -f docs/index.yaml

      - name: Read chart list and download
        run: |
          while IFS=',' read -r repo_url chart_name chart_version || [ -n "$repo_url" ]; do
            # ë¹ˆ ì¤„ì´ë‚˜ ì£¼ì„ ìŠ¤í‚µ
            if [[ -z "$repo_url" ]] || [[ "$repo_url" =~ ^# ]]; then
              continue
            fi

            # ê³µë°± ì œê±°
            repo_url=$(echo "$repo_url" | xargs)
            chart_name=$(echo "$chart_name" | xargs)
            chart_version=$(echo "$chart_version" | xargs)

            echo "Processing: $chart_name version $chart_version from $repo_url"

            # Helm repo ì¶”ê°€ repo_urlì—ì„œ https:// ì™€ ì²« . ê¹Œì§€ ê°’ì— temp- ë¶™ì„
            repo_name="temp-$(echo $repo_url | sed 's|https://||;s|/.*||;s|:|--|g')"
            if ! helm repo add "$repo_name" "$repo_url"; then
              echo "Failed to add repository: $repo_url"
              continue
            fi

            helm repo update "$repo_name"

            # ì¤‘ë³µ íŒŒì¼ ë°©ì§€ë¥¼ ìœ„í•´ ê¸°ì¡´ì— ë™ì¼í•œ ì´ë¦„ì˜ .tgz íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
            expected_tgz=$(find docs -maxdepth 1 -type f -name "${chart_name}-*${chart_version}*.tgz" | head -n1)

            # ì°¨íŠ¸ê°€ ì´ë¯¸ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°ì—ë§Œ ë‹¤ìš´ë¡œë“œ
            if [ ! -f "$expected_tgz" ]; then
              echo "Downloading $chart_name version $chart_version..."
              if helm pull "$repo_name/$chart_name" --version "$chart_version" --destination docs; then
                echo "Successfully downloaded $chart_name-$chart_version"

                # chart_versionì˜ ì²« ê¸€ìê°€ ìˆ«ìê°€ ì•„ë‹ˆë©´ í•´ë‹¹ ë¬¸ìë§Œ ì œì™¸ (ì˜ˆ: v1.2.3 â†’ 1.2.3)
                search_version="$chart_version"
                if [[ ! $chart_version =~ ^[0-9] ]]; then
                  search_version="${chart_version:1}"
                fi
                downloaded_file=$(find docs -maxdepth 1 -type f -name "${chart_name}-*${search_version}*.tgz" | head -n1)

                # ë‹¤ìš´ë¡œë“œí•œ íŒŒì¼ì„ charts/ ë””ë ‰í† ë¦¬ì— ì••ì¶• í•´ì œ
                rm -rf "charts/${chart_name}"
                tar -xzf "$downloaded_file" -C charts
              else
                echo "Failed to download $chart_name version $chart_version"
              fi
            else
              echo "Chart $chart_name-$chart_version already exists, skipping download"
            fi

          done < ghe-helm-charts/asserts/helm-charts.txt

      - name: Generate index.yaml
        run: |
          cd docs
          # index.yaml ìƒì„±
          helm repo index .
          cd ..

      - name: Generate index.html
        run: |
          cat > docs/index.html <<'EOF'
          <!DOCTYPE html>
          <html lang="ko">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>helm-charts Packages</title>
            <style>
              body { font-family: Arial, sans-serif; max-width: 1200px; margin: 50px auto; padding: 20px; }
              h1 { color: #333; }
              ul { list-style-type: none; padding: 0; }
              li { padding: 8px; border-bottom: 1px solid #eee; }
              code { background: #f4f4f4; padding: 10px; display: block; margin: 10px 0; border-radius: 4px; }
              .command { background: #2d2d2d; color: #f8f8f8; }
            </style>
          </head>
          <body>
            <h1>ğŸ¯ ghe-helm-charts Packages</h1>
            <h2>ğŸ“¦ Available Charts</h2>
            <ul>
          EOF

          # .tgz íŒŒì¼ ëª©ë¡ ì¶”ê°€
          for file in docs/*.tgz; do
            if [ -f "$file" ]; then
              fname=$(basename "$file")
              echo "    <li><a href=\"./$fname\" target=\"_blank\">$fname</a></li>"
            fi
          done >> docs/index.html

          cat >> docs/index.html <<'EOF'
            </ul>

            <h2>ğŸš€ Usage</h2>
            <h3>Helm Repository ë“±ë¡</h3>
            <code class="command">helm repo add ghe-charts https://YOUR-GITHUB/pages/Tech/ghe-helm-charts/ (--username GITHUB_USER --password GITHUB_TOKEN)</code>
            <h4>--username ì™€ --password ì˜µì…˜ì€ github pages ì„¤ì •ì´ í¼ë¸”ë¦­ì´ ì•„ë‹ ê²½ìš°ì—ë§Œ í•„ìš”í•©ë‹ˆë‹¤.</h4>

            <h3>Repository ì—…ë°ì´íŠ¸</h3>
            <code class="command">helm repo update ghe-charts</code>

            <h3>ì‚¬ìš© ê°€ëŠ¥í•œ ì°¨íŠ¸ ê²€ìƒ‰</h3>
            <code class="command">helm search repo ghe-charts</code>

            <h3>ì°¨íŠ¸ ì„¤ì¹˜</h3>
            <code class="command">helm install my-release ghe-charts/[chart-name]</code>
          </body>
          </html>
          EOF

      # # ì»¤ë°‹ ë° í‘¸ì‹œ ë‹¨ê³„ (ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ì£¼ì„ ì²˜ë¦¬ í•´ì œí•´ì•¼ í•¨)
      # - name: set git config
      #   run: |
      #     git config --global user.name "devops"
      #     git config --global user.email "devops@github.com"

      # - name: Commit and push changes
      #   run: |
      #     # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
      #     if [[ -n $(git status -s) ]]; then
      #       git add charts docs
      #       git commit -m "Update charts and packages automatically [skip ci]" || true
      #       git push
      #       echo "âœ“ Changes committed and pushed"
      #     else
      #       echo "â„¹ No changes to commit"
      #     fi

      # - name: Notify on failure
      #   if: failure() && (env.SLACK_WEBHOOK_URL != '')
      #   run: |
      #     echo "Mirror operation failed!"
      #     echo "Event: ${{ github.event_name }}"
      #     echo "Action: ${{ github.event.action }}"
      #     echo "Ref: ${{ github.ref }}"
      #     echo "Event Ref: ${{ github.event.ref }}"
      #     echo "Ref Type: ${{ github.event.ref_type }}"
      #     # ì—¬ê¸°ì— Slack, ì´ë©”ì¼ ë˜ëŠ” ë‹¤ë¥¸ ì•Œë¦¼ ì‹œìŠ¤í…œì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      #     # ì˜ˆ: curl -X POST -H 'Content-type: application/json' --data '{"text":"Mirror failed for ${{ github.repository }}"}' ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: cleanup
        if: always()
        run: |
          # remove temp helm repo
          helm repo remove $(helm repo list | grep temp- | awk '{print $1}' ) || true
