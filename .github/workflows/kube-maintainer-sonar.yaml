name: App Sonar with Trivy SonarQube Integration

on:
  pull_request:
    branches:
      - main
      - release/**
      - "dependabot/**" # Dependabot ë¸Œëžœì¹˜ ì¶”ê°€
    # paths:
    #   - "kube-maintainer/**"
  workflow_dispatch:

env:
  GIT_EVENT: ${{ github.event_name }}
  REPOSITORY: "kube-maintainer"
  SONAR_HOST_URL: ${{ vars.SONAR_HOST_URL }}
  EXIT_FAILURE_CODE: ${{ vars.EXIT_FAILURE_CODE || '1' }}
  MAX_CRITICAL_VULNERABILITIES: ${{ vars.MAX_CRITICAL_VULNERABILITIES || '0' }}
  MAX_HIGH_VULNERABILITIES: ${{ vars.MAX_HIGH_VULNERABILITIES || '5' }}
jobs:
  build:
    runs-on: [ubuntu-latest]
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          # pull_request_targetì€ ê¸°ë³¸ì ìœ¼ë¡œ base ë¸Œëžœì¹˜ë¥¼ checkoutí•˜ë¯€ë¡œ, PRì˜ headë¥¼ ëª…ì‹œì ìœ¼ë¡œ checkoutí•´ì•¼ í•¨
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Install latest Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          trivy --version

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          cd kube-maintainer
          python -m venv venv
          source venv/bin/activate
          pip install -r requirements.txt
          pip install coverage

      - name: Run tests and measure coverage
        run: |
          cd kube-maintainer
          source venv/bin/activate
          coverage run -m unittest discover -s tests
          coverage report
          coverage xml

      - name: Build Docker image
        if: github.actor == 'dependabot[bot]' || github.event.pull_request.head.repo.full_name == github.repository
        run: |
          docker buildx create --use --name maintainer_builder
          docker buildx build --platform linux/amd64,linux/arm64 \
            -f kube-maintainer/Dockerfile \
            -t ${{ env.REPOSITORY }}:${{ github.sha }} \
            kube-maintainer
          docker buildx rm maintainer_builder

      # Trivy ìŠ¤ìº” ì‹¤í–‰
      # local image scan
      - name: Run Trivy vulnerability scanner
        if: github.actor == 'dependabot[bot]' || github.event.pull_request.head.repo.full_name == github.repository
        run: |
          # For Intergrate to Sonarqube
          trivy image ${{ env.REPOSITORY }}:${{ github.sha }} \
            --scanners=vuln \
            --pkg-types=os,library \
            --exit-code=0 \
            --format=sarif \
            --output=trivy-report.sarif \
            --severity=CRITICAL,HIGH \
            --ignore-unfixed

          # For PR Comment
          trivy image ${{ env.REPOSITORY }}:${{ github.sha }} \
            --scanners=vuln \
            --pkg-types=os,library \
            --exit-code=0 \
            --format=json \
            --output=trivy-report.json \
            --severity=CRITICAL,HIGH \
            --ignore-unfixed
          # ìƒì„±í•œ trivy-report.*ë¥¼ /tmp ìž„ì‹œ í´ë”ë¥¼ ìƒì„±í•˜ê³  ì´ë™
          TEMP_REPORTS_DIR=$(mktemp -d /tmp/trivy-reports-XXXX)
          mv trivy-report.* "$TEMP_REPORTS_DIR"
          echo "TEMP_REPORTS_DIR=$TEMP_REPORTS_DIR" >> $GITHUB_ENV

      - name: Analyze SonarQube with Trivy Report
        if: github.actor == 'dependabot[bot]' || github.event.pull_request.head.repo.full_name == github.repository
        uses: SonarSource/sonarqube-scan-action@v5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=${{ env.REPOSITORY }}
            -Dsonar.sources=${{ env.REPOSITORY }}
            -Dsonar.language=py
            -Dsonar.python.version=3.13
            -Dsonar.sarifReportPaths=${{ env.TEMP_REPORTS_DIR }}/trivy-report.sarif
            -Dsonar.python.coverage.reportPaths=kube-maintainer/coverage.xml

      # SonarQube Quality Gate ëŒ€ê¸° ë° ê²°ê³¼ íŒŒì‹±
      - name: Wait SonarQube Quality Gate and parsing results
        if: github.actor == 'dependabot[bot]' || github.event.pull_request.head.repo.full_name == github.repository
        id: parse-sonar
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          set -e
          # ceTaskIdì™€ projectKey ì¶”ì¶œ
          REPORT_TASK_FILE=".scannerwork/report-task.txt"
          ceTaskId=$(grep 'ceTaskId=' "$REPORT_TASK_FILE" | cut -d'=' -f2)
          componentKey=$(grep 'projectKey=' "$REPORT_TASK_FILE" | cut -d'=' -f2)
          echo "SonarQube ceTaskId: $ceTaskId"
          echo "SonarQube componentKey: $componentKey"
          TIMEOUT=300
          INTERVAL=10
          ELAPSED=0
          STATUS="NONE"

          # ceTaskId ìƒíƒœ polling
          while [ $ELAPSED -lt $TIMEOUT ]; do
            TASK_STATUS=$(curl -s -u "$SONAR_TOKEN:" "$SONAR_HOST_URL/api/ce/task?id=$ceTaskId" | jq -r '.task.status')
            echo "SonarQube Task ìƒíƒœ: $TASK_STATUS ($ELAPSED/$TIMEOUT ì´ˆ)"
            if [ "$TASK_STATUS" = "SUCCESS" ]; then
              break
            elif [ "$TASK_STATUS" = "FAILED" ]; then
              echo "SonarQube ë¶„ì„ ì‹¤íŒ¨"
              break
            fi
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done

          if [ $ELAPSED -ge $TIMEOUT ]; then
            echo "â° SonarQube Task í™•ì¸ ì‹œê°„ ì´ˆê³¼"
            exit ${{ env.EXIT_FAILURE_CODE }}
          fi

          # Quality Gate ê²°ê³¼ í™•ì¸
          QUALITY_GATE=$(curl -s -u "$SONAR_TOKEN:" "$SONAR_HOST_URL/api/qualitygates/project_status?projectKey=$componentKey")
          STATUS=$(echo "$QUALITY_GATE" | jq -r '.projectStatus.status // "ERROR"')

          # ì£¼ìš” ë©”íŠ¸ë¦­(ë“±ê¸‰, ì»¤ë²„ë¦¬ì§€, ì¤‘ë³µë¥ , ë¼ì¸ ìˆ˜ ë“±) ì¡°íšŒ
          METRICS=$(curl -s -u "$SONAR_TOKEN:" "$SONAR_HOST_URL/api/measures/component?component=$componentKey&metricKeys=security_rating,reliability_rating,sqale_rating,coverage,duplicated_lines_density,ncloc")

          # ì´ìŠˆ ê°œìˆ˜ ì¡°íšŒ
          ISSUES=$(curl -s -u "$SONAR_TOKEN:" "$SONAR_HOST_URL/api/issues/search?componentKeys=$componentKey&resolved=false" | jq '.total')

          echo "ìµœì¢… Quality Gate ìƒíƒœ: $STATUS"
          echo "ì£¼ìš” ë©”íŠ¸ë¦­: $METRICS"
          echo "í•´ê²°ë˜ì§€ ì•Šì€ ì´ìŠˆ ê°œìˆ˜: $ISSUES"
          echo "$QUALITY_GATE" > sonar-quality-gate.json
          echo "sonar_status=$STATUS" >> $GITHUB_OUTPUT
          echo "sonar_metrics=$METRICS" >> $GITHUB_OUTPUT
          echo "sonar_issues=$ISSUES" >> $GITHUB_OUTPUT

      # PR ì½”ë©˜íŠ¸ ìƒì„± ë¶€ë¶„ë§Œ ìˆ˜ì •ëœ ë²„ì „
      - name: Create PR Comment
        if: github.event.pull_request && (github.actor == 'dependabot[bot]' || github.event.pull_request.head.repo.full_name == github.repository)
        uses: actions/github-script@v7
        env:
          REPOSITORY: ${{ env.REPOSITORY }}
          TEMP_REPORTS_DIR: ${{ env.TEMP_REPORTS_DIR }}
          SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}
          SONAR_METRICS: ${{ steps.parse-sonar.outputs.sonar_metrics }}
          SONAR_ISSUES: ${{ steps.parse-sonar.outputs.sonar_issues }}
          SONAR_STATUS: ${{ steps.parse-sonar.outputs.sonar_status }}
        with:
          script: |
            const fs = require("fs");

            try {
              // Trivy ê²°ê³¼ íŒŒì‹± (PR ì½”ë©˜íŠ¸ìš©)
              let trivyResults = "";
              try {
                const trivyReportPath = `${process.env.TEMP_REPORTS_DIR}/trivy-report.json`;

                if (fs.existsSync(trivyReportPath)) {
                  const trivyData = JSON.parse(fs.readFileSync(trivyReportPath, "utf8"));
                  const vulnerabilities = trivyData.Results || [];

                  if (vulnerabilities.length > 0) {
                    trivyResults += "## ðŸš¨ Trivy ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼\n\n";
                    let criticalCount = 0,
                      highCount = 0,
                      mediumCount = 0;

                    vulnerabilities.forEach((result) => {
                      if (result.Vulnerabilities) {
                        trivyResults += `### ðŸ” ${result.Target}\n`;
                        result.Vulnerabilities.forEach((vuln) => {
                          switch (vuln.Severity) {
                            case "CRITICAL":
                              criticalCount++;
                              break;
                            case "HIGH":
                              highCount++;
                              break;
                            case "MEDIUM":
                              mediumCount++;
                              break;
                          }
                          trivyResults += `- **${vuln.Severity}**: \`${vuln.VulnerabilityID}\` - ${vuln.Title}\n`;
                        });
                        trivyResults += "\n";
                      }
                    });

                    trivyResults += `**ìš”ì•½:** ðŸ”´ Critical: ${criticalCount} | ðŸŸ  High: ${highCount} | ðŸŸ¡ Medium: ${mediumCount}\n\n`;
                    trivyResults += `ðŸ“Š **SonarQube í†µí•©**: ì·¨ì•½ì  ì •ë³´ê°€ SonarQubeì— ìžë™ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\n\n`;
                  } else {
                    trivyResults +=
                      "## âœ… Trivy ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼\nì·¨ì•½ì ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\n";
                  }
                } else {
                  trivyResults +=
                    "## âš ï¸ Trivy ë³´ì•ˆ ìŠ¤ìº”\nTrivy ìŠ¤ìº” ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\n";
                }
              } catch (trivyError) {
                console.error("Trivy ê²°ê³¼ íŒŒì‹± ì˜¤ë¥˜:", trivyError);
                trivyResults +=
                  "## âš ï¸ Trivy ë³´ì•ˆ ìŠ¤ìº”\nê²°ê³¼ íŒŒì‹± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n";
              }

              // SonarQube ê²°ê³¼ íŒŒì‹±
              let sonarResults = "";
              try {
                // Quality Gate ìƒíƒœ
                const status = process.env.SONAR_STATUS || "UNKNOWN";
                const statusIcon =
                  status === "OK" ? "âœ…" : status === "ERROR" ? "âŒ" : "âš ï¸";

                sonarResults += "## ðŸ“Š SonarQube í’ˆì§ˆ ë¶„ì„ ê²°ê³¼\n\n";
                sonarResults += `**Quality Gate:** ${statusIcon} ${status}\n\n`;

                // ë©”íŠ¸ë¦­ parsing
                if (process.env.SONAR_METRICS) {
                  const metrics = JSON.parse(process.env.SONAR_METRICS);
                  const metricMap = {};
                  if (metrics.component && metrics.component.measures) {
                    metrics.component.measures.forEach((measure) => {
                      metricMap[measure.metric] = measure.value;
                    });

                    sonarResults += "### ðŸ“Š SonarQube ì£¼ìš” ë©”íŠ¸ë¦­\n\n";
                    sonarResults += `- **ì‹ ë¢°ì„±:** ${metricMap["reliability_rating"] || "N/A"}\n`;
                    sonarResults += `- **ë³´ì•ˆ:** ${metricMap["security_rating"] || "N/A"}\n`;
                    sonarResults += `- **ìœ ì§€ë³´ìˆ˜ì„±:** ${metricMap["sqale_rating"] || "N/A"}\n`;
                    sonarResults += `- **ì»¤ë²„ë¦¬ì§€:** ${metricMap["coverage"] || "0.0"}%\n`;
                    sonarResults += `- **ì¤‘ë³µë¥ :** ${metricMap["duplicated_lines_density"] || "0.0"}%\n`;
                    sonarResults += `- **ë¼ì¸ ìˆ˜:** ${metricMap["ncloc"] || "0"}\n`;
                  }
                }

                // í•´ê²°ë˜ì§€ ì•Šì€ ì´ìŠˆ ê°œìˆ˜
                if (process.env.SONAR_ISSUES) {
                  const issuesCount = process.env.SONAR_ISSUES;
                  sonarResults += `- **í•´ê²°ë˜ì§€ ì•Šì€ ì´ìŠˆ ê°œìˆ˜:** ${issuesCount}\n\n`;
                }

              } catch (sonarError) {
                console.error("SonarQube ê²°ê³¼ íŒŒì‹± ì˜¤ë¥˜:", sonarError);
                sonarResults +=
                  "## âš ï¸ SonarQube ë¶„ì„ ê²°ê³¼\nê²°ê³¼ íŒŒì‹± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n";
              }

              // SonarQube ë§í¬ ì¶”ê°€
              const projectKey = process.env.REPOSITORY;
              const sonarHostUrl = process.env.SONAR_HOST_URL;
              const sonarQubeResults = `## ðŸ“Š SonarQube í†µí•© ê²°ê³¼\n\nâœ… **Trivy ì·¨ì•½ì  ì •ë³´ê°€ SonarQubeì— ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤**\n\n[ðŸ”— SonarQubeì—ì„œ ì „ì²´ ê²°ê³¼ ë³´ê¸°](${sonarHostUrl}/dashboard?id=${projectKey})\n\n`;

              // ì§€í‘œ ì„¤ëª… ì¶”ê°€
              const metricDescription = `
              ---
              ## ðŸ“– SonarQube ì£¼ìš” ì§€í‘œ ì„¤ëª…

              - **ì‹ ë¢°ì„±**: ë²„ê·¸(ìž ìž¬ì  ì˜¤ë¥˜) ìˆ˜ì¤€ì„ ë“±ê¸‰(A ~ E, 1.0 ~ 5.0)ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤. 1.0(A)ì´ ê°€ìž¥ ìš°ìˆ˜í•©ë‹ˆë‹¤.
              - **ë³´ì•ˆ**: ë³´ì•ˆ ì·¨ì•½ì  ìˆ˜ì¤€ì„ ë“±ê¸‰(A ~ E, 1.0 ~ 5.0)ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.
              - **ìœ ì§€ë³´ìˆ˜ì„±**: ì½”ë“œ ìŠ¤ë©œ(ë¹„íš¨ìœ¨ì /ë¹„í‘œì¤€ ì½”ë“œ) ìˆ˜ì¤€ì„ ë“±ê¸‰(A ~ E, 1.0 ~ 5.0)ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.
              - **ì»¤ë²„ë¦¬ì§€**: ì „ì²´ ì½”ë“œ ì¤‘ í…ŒìŠ¤íŠ¸ë¡œ ê²€ì¦ëœ ì½”ë“œ ë¹„ìœ¨(%). 70% ì´ìƒì´ ê¶Œìž¥ë©ë‹ˆë‹¤.
              - **ì¤‘ë³µë¥ **: ì „ì²´ ì½”ë“œ ì¤‘ ì¤‘ë³µëœ ë¼ì¸ì˜ ë¹„ìœ¨(%). 3% ì´í•˜ê°€ ê¶Œìž¥ë©ë‹ˆë‹¤.
              - **ë¼ì¸ ìˆ˜**: ë¶„ì„ëœ ì „ì²´ ì½”ë“œ ë¼ì¸ ìˆ˜ìž…ë‹ˆë‹¤.
              - **í•´ê²°ë˜ì§€ ì•Šì€ ì´ìŠˆ ê°œìˆ˜**: í˜„ìž¬ê¹Œì§€ í•´ê²°ë˜ì§€ ì•Šì€ ë²„ê·¸, ì·¨ì•½ì , ì½”ë“œ ìŠ¤ë©œì˜ ì´ ê°œìˆ˜ìž…ë‹ˆë‹¤.
              `;

              // ì „ì²´ ì½”ë©˜íŠ¸ êµ¬ì„±
              const commentBody = `# ðŸ” ì½”ë“œ í’ˆì§ˆ & ë³´ì•ˆ ë¶„ì„ ë¦¬í¬íŠ¸

              ${trivyResults}
              ${sonarResults}
              ${sonarQubeResults}
              ${metricDescription}

              ---

              **ë¶„ì„ ì •ë³´:**
              - ðŸ“„ ì‹¤í–‰ ì‹œê°„: ${new Date().toLocaleString("ko-KR")}
              - ðŸ” ì»¤ë°‹: \`${context.sha.substring(0, 7)}\`
              - ðŸŒ³ ë¸Œëžœì¹˜: \`${context.ref.replace("refs/heads/", "")}\`

              > ì´ ë¦¬í¬íŠ¸ëŠ” ìžë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ðŸ¤–
              `;

              // ê¸°ì¡´ ë´‡ ì½”ë©˜íŠ¸ ì°¾ê¸° ë° ìƒì„±/ì—…ë°ì´íŠ¸
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });

              const existingComment = comments.find(
                (comment) =>
                  (comment.user.type === "Bot" ||
                    comment.user.login === "github-actions[bot]") &&
                  comment.body &&
                  comment.body.includes("ðŸ” ì½”ë“œ í’ˆì§ˆ & ë³´ì•ˆ ë¶„ì„ ë¦¬í¬íŠ¸")
              );

              if (existingComment && existingComment.id) {
                console.log(`ê¸°ì¡´ ì½”ë©˜íŠ¸ ì—…ë°ì´íŠ¸: ${existingComment.id}`);
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existingComment.id,
                  body: commentBody,
                });
              } else {
                console.log("ìƒˆ ì½”ë©˜íŠ¸ ìƒì„±");
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: commentBody,
                });
              }

            } catch (mainError) {
              console.error("PR ì½”ë©˜íŠ¸ ìƒì„± ì¤‘ ì „ì²´ ì˜¤ë¥˜:", mainError);

              // ì—ëŸ¬ ë°œìƒ ì‹œ ê¸°ë³¸ ì½”ë©˜íŠ¸ ìƒì„±
              const errorCommentBody = `# âš ï¸ ì½”ë“œ í’ˆì§ˆ & ë³´ì•ˆ ë¶„ì„ ì˜¤ë¥˜

              ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìžì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.

              **ì˜¤ë¥˜ ì •ë³´:**
              - ðŸ“„ ì‹¤í–‰ ì‹œê°„: ${new Date().toLocaleString("ko-KR")}
              - ðŸ” ì»¤ë°‹: \`${context.sha.substring(0, 7)}\`
              - ðŸŒ³ ë¸Œëžœì¹˜: \`${context.ref.replace("refs/heads/", "")}\`

              > ì´ ë¦¬í¬íŠ¸ëŠ” ìžë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ðŸ¤–`;

              try {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: errorCommentBody,
                });
              } catch (commentError) {
                console.error("ì—ëŸ¬ ì½”ë©˜íŠ¸ ìƒì„± ì‹¤íŒ¨:", commentError);
              }

              throw mainError;
            }

      # Quality Gate ê²€ì¦ ë° Trivy ì·¨ì•½ì  ê²€ì¦
      - name: Check SonarQube Quality Gate and Trivy Vulnerabilities
        if: github.actor == 'dependabot[bot]' || github.event.pull_request.head.repo.full_name == github.repository
        run: |
          STATUS="${{ steps.parse-sonar.outputs.sonar_status }}"
          echo "SonarQube ìŠ¤ìº” ê²°ê³¼ ê²€ì¦ ì‹œìž‘..."
          # SonarQube Quality Gate ìƒíƒœ í™•ì¸
          if [ "$STATUS" = "OK" ]; then
            echo "âœ… SonarQube Quality Gate í†µê³¼"
          elif [ "$STATUS" = "ERROR" ]; then
            echo "âŒ SonarQube Quality Gate ì‹¤íŒ¨"
            exit ${{ env.EXIT_FAILURE_CODE }}
          elif [ "$STATUS" = "NONE" ]; then
            echo "âš ï¸ Quality Gateê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ"
            exit ${{ env.EXIT_FAILURE_CODE }}
          fi
          echo "Trivy ì·¨ì•½ì  ê²€ì¦ ì‹œìž‘..."
          # í™˜ê²½ë³€ìˆ˜ì—ì„œ ìž„ì‹œ ë””ë ‰í† ë¦¬ ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°
          TRIVY_REPORT_PATH="$TEMP_REPORTS_DIR/trivy-report.json"
          echo "Trivy ë¦¬í¬íŠ¸ ê²½ë¡œ: $TRIVY_REPORT_PATH"
          if [ ! -f "$TRIVY_REPORT_PATH" ]; then
            echo "âŒ Trivy ë³´ê³ ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $TRIVY_REPORT_PATH"
            echo "ì·¨ì•½ì  ê²€ì¶œë¡œ ì¸í•œ merge fail"
            exit ${{ env.EXIT_FAILURE_CODE }}
          fi
          # JSON íŒŒì¼ ì¡´ìž¬ ë° ìœ íš¨ì„± í™•ì¸
          if ! jq empty "$TRIVY_REPORT_PATH" 2>/dev/null; then
            echo "âŒ Trivy ë³´ê³ ì„œ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤"
            echo "ì·¨ì•½ì  ê²€ì¶œë¡œ ì¸í•œ merge fail"
            exit ${{ env.EXIT_FAILURE_CODE }}
          fi
          # CRITICAL, HIGH ì·¨ì•½ì  ê°œìˆ˜ ê³„ì‚°
          CRITICAL_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' "$TRIVY_REPORT_PATH")
          HIGH_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' "$TRIVY_REPORT_PATH")
          echo "ë°œê²¬ëœ ì·¨ì•½ì :"
          echo "ðŸ”´ CRITICAL: $CRITICAL_COUNT"
          echo "ðŸŸ  HIGH: $HIGH_COUNT"
          # ì·¨ì•½ì  ìž„ê³„ê°’ ì„¤ì • (í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì • ê°€ëŠ¥í•˜ë„ë¡)
          MAX_CRITICAL=${{ env.MAX_CRITICAL_VULNERABILITIES }}
          MAX_HIGH=${{ env.MAX_HIGH_VULNERABILITIES }}
          echo "í—ˆìš© ìž„ê³„ê°’:"
          echo "ðŸ”´ CRITICAL ìµœëŒ€: $MAX_CRITICAL"
          echo "ðŸŸ  HIGH ìµœëŒ€: $MAX_HIGH"
          # ì·¨ì•½ì  ì²´í¬
          FAIL_REASON=""
          if [ "$CRITICAL_COUNT" -gt "$MAX_CRITICAL" ]; then
            FAIL_REASON="${FAIL_REASON}CRITICAL ì·¨ì•½ì  $CRITICAL_COUNT ê°œ ë°œê²¬ (í—ˆìš©: $MAX_CRITICAL ê°œ).\n"
          fi
          if [ "$HIGH_COUNT" -gt "$MAX_HIGH" ]; then
            FAIL_REASON="${FAIL_REASON}HIGH ì·¨ì•½ì  $HIGH_COUNT ê°œ ë°œê²¬ (í—ˆìš©: $MAX_HIGH ê°œ).\n"
          fi
          # Quality Gate ì‹¤íŒ¨ ì‹œ ì¶”ê°€
          if [ "$STATUS" = "ERROR" ]; then
            FAIL_REASON="${FAIL_REASON}SonarQube Quality Gate: Failed.\n"
          fi
          if [ -n "$FAIL_REASON" ]; then
            echo "âŒ ì·¨ì•½ì  ìž„ê³„ê°’ ì´ˆê³¼"
            echo -e "$FAIL_REASON"
            echo "ì·¨ì•½ì  ê²€ì¶œë¡œ ì¸í•œ merge fail"
            exit ${{ env.EXIT_FAILURE_CODE }}
          else
            echo "âœ… Trivy ì·¨ì•½ì  ê²€ì‚¬ í†µê³¼"
          fi

      - name: Cleanup Temporary Reports
        if: always()
        run: |
          echo "Docker ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
          docker rmi ${{ env.REPOSITORY }}:${{ github.sha }} 2>/dev/null || true
          echo "ìž„ì‹œ ë³´ê³ ì„œ ì •ë¦¬ ì¤‘..."
          rm -rf "$TEMP_REPORTS_DIR" 2>/dev/null || true
          rm -f sonar-quality-gate.json 2>/dev/null || true
